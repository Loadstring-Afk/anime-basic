<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="animeTitle">Anime Details - AniLab</title>
    
    <!-- CSS -->
    <link rel="stylesheet" href="/css/tailwind.output.css">
    <link rel="stylesheet" href="/css/glass.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        .anime-detail-hero {
            background: linear-gradient(rgba(0,0,0,0.8), rgba(0,0,0,0.8)),
                        var(--anime-background, url('/assets/background.png')) center/cover;
            min-height: 400px;
        }
        
        .episode-list {
            max-height: 600px;
            overflow-y: auto;
        }
        
        .episode-list::-webkit-scrollbar {
            width: 8px;
        }
        
        .episode-list::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }
        
        .episode-list::-webkit-scrollbar-thumb {
            background: rgba(147, 51, 234, 0.5);
            border-radius: 4px;
        }
        
        .character-card {
            transition: all 0.3s ease;
        }
        
        .character-card:hover {
            transform: translateY(-5px);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body class="bg-gray-900 text-white">
    <!-- Navigation -->
    <nav class="navbar glass py-4 px-6 fixed w-full z-50">
        <div class="container mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <a href="/" id="logo">
                    <img src="/assets/logo.png" alt="AniLab" class="h-10 w-auto">
                </a>
                <div class="hidden md:flex space-x-6">
                    <a href="/home" class="text-gray-300 hover:text-white">Home</a>
                    <a href="/top-airing" class="text-gray-300 hover:text-white">Top Airing</a>
                    <a href="/recently-added" class="text-gray-300 hover:text-white">New Episodes</a>
                </div>
            </div>
            
            <div class="flex-1 max-w-xl mx-8">
                <div class="field">
                    <div class="control has-icons-left">
                        <input class="input glass-input pl-5 pr-10" type="text" placeholder="Search anime...">
                        <span class="icon is-left">
                            <i class="fas fa-search text-gray-400"></i>
                        </span>
                    </div>
                </div>
            </div>
            
            <div class="flex items-center space-x-4">
                <a href="/continue-watching" class="text-white hover:text-purple-300">
                    <i class="fas fa-history text-xl"></i>
                </a>
            </div>
        </div>
    </nav>

    <!-- Anime Details -->
    <main class="pt-20">
        <!-- Hero Section -->
        <section id="animeHero" class="anime-detail-hero px-4 md:px-8 py-8">
            <div class="container mx-auto">
                <div class="md:flex">
                    <!-- Poster -->
                    <div class="md:w-1/4 mb-8 md:mb-0 md:mr-8">
                        <img id="animePoster" 
                             src="/assets/placeholder.jpg" 
                             alt="Anime Poster"
                             class="w-full rounded-xl shadow-2xl anime-poster">
                    </div>
                    
                    <!-- Details -->
                    <div class="md:w-3/4">
                        <div class="flex flex-wrap items-center mb-4">
                            <h1 id="animeMainTitle" class="text-4xl font-bold mr-4"></h1>
                            <span id="animeType" class="tag is-dark text-lg"></span>
                        </div>
                        
                        <h2 id="animeAltTitle" class="text-xl text-gray-300 mb-6"></h2>
                        
                        <!-- Info Grid -->
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="glass-card p-4 rounded-lg">
                                <div class="text-sm text-gray-400">Status</div>
                                <div id="animeStatus" class="font-bold"></div>
                            </div>
                            <div class="glass-card p-4 rounded-lg">
                                <div class="text-sm text-gray-400">Episodes</div>
                                <div id="animeEpisodes" class="font-bold"></div>
                            </div>
                            <div class="glass-card p-4 rounded-lg">
                                <div class="text-sm text-gray-400">Duration</div>
                                <div id="animeDuration" class="font-bold"></div>
                            </div>
                            <div class="glass-card p-4 rounded-lg">
                                <div class="text-sm text-gray-400">Rating</div>
                                <div id="animeRating" class="font-bold"></div>
                            </div>
                        </div>
                        
                        <!-- Synopsis -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold mb-3">Synopsis</h3>
                            <p id="animeSynopsis" class="text-gray-300 leading-relaxed"></p>
                        </div>
                        
                        <!-- Genres -->
                        <div class="mb-8">
                            <h3 class="text-xl font-bold mb-3">Genres</h3>
                            <div id="animeGenres" class="flex flex-wrap gap-2"></div>
                        </div>
                        
                        <!-- Action Buttons -->
                        <div class="flex flex-wrap gap-4">
                            <button id="watchFirstEp" class="button is-primary is-large font-bold">
                                <i class="fas fa-play mr-2"></i>
                                Watch Episode 1
                            </button>
                            <button id="addToWatchlist" class="button is-light is-large">
                                <i class="fas fa-plus mr-2"></i>
                                Add to Watchlist
                            </button>
                            <button id="shareAnime" class="button is-light is-large">
                                <i class="fas fa-share-alt mr-2"></i>
                                Share
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- Tabs Navigation -->
        <section class="px-4 md:px-8 py-4">
            <div class="container mx-auto">
                <div class="tabs is-centered">
                    <ul>
                        <li class="tab-link is-active" data-tab="episodes"><a>Episodes</a></li>
                        <li class="tab-link" data-tab="characters"><a>Characters</a></li>
                        <li class="tab-link" data-tab="recommendations"><a>Recommendations</a></li>
                        <li class="tab-link" data-tab="details"><a>Details</a></li>
                    </ul>
                </div>
            </div>
        </section>

        <!-- Tab Content -->
        <section class="px-4 md:px-8 py-8">
            <div class="container mx-auto">
                <!-- Episodes Tab -->
                <div id="episodes" class="tab-content active">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold">Episodes</h2>
                        <div class="flex space-x-4">
                            <div class="buttons has-addons">
                                <button class="button is-small episode-filter active" data-lang="all">
                                    All
                                </button>
                                <button class="button is-small episode-filter" data-lang="sub">
                                    Sub
                                </button>
                                <button class="button is-small episode-filter" data-lang="dub">
                                    Dub
                                </button>
                            </div>
                        </div>
                    </div>
                    <div id="episodeList" class="episode-list grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                        <!-- Episodes loaded dynamically -->
                    </div>
                </div>

                <!-- Characters Tab -->
                <div id="characters" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">Characters & Voice Actors</h2>
                    <div id="characterList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- Characters loaded dynamically -->
                    </div>
                </div>

                <!-- Recommendations Tab -->
                <div id="recommendations" class="tab-content">
                    <h2 class="text-2xl font-bold mb-6">Recommended Anime</h2>
                    <div id="recommendationList" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4">
                        <!-- Recommendations loaded dynamically -->
                    </div>
                </div>

                <!-- Details Tab -->
                <div id="details" class="tab-content">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                        <div>
                            <h3 class="text-xl font-bold mb-4">Information</h3>
                            <div id="animeDetails" class="space-y-3">
                                <!-- Details loaded dynamically -->
                            </div>
                        </div>
                        <div>
                            <h3 class="text-xl font-bold mb-4">Statistics</h3>
                            <div id="animeStats" class="space-y-4">
                                <!-- Stats loaded dynamically -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="glass py-8 px-6 mt-12">
        <div class="container mx-auto text-center text-gray-400">
            <p>Â© 2024 AniLab. All anime content is provided by third-party APIs.</p>
        </div>
    </footer>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/animejs@3.2.1/lib/anime.min.js"></script>
    <script src="/js/animations.js"></script>
    
    <script>
        // Get anime ID from URL
        function getAnimeIdFromUrl() {
            const path = window.location.pathname;
            const match = path.match(/\/anime\/([^\/]+)/);
            return match ? match[1] : null;
        }
        
        document.addEventListener('DOMContentLoaded', async () => {
            const animeId = getAnimeIdFromUrl();
            
            if (!animeId) {
                window.location.href = '/404.html';
                return;
            }
            
            // Store anime ID for continue watching
            const animeIdInput = document.createElement('input');
            animeIdInput.type = 'hidden';
            animeIdInput.id = 'animeId';
            animeIdInput.value = animeId;
            document.body.appendChild(animeIdInput);
            
            // Load anime details
            await loadAnimeDetails(animeId);
            
            // Initialize tabs
            initTabs();
            
            // Initialize episode filters
            initEpisodeFilters();
        });
        
        async function loadAnimeDetails(animeId) {
            try {
                const response = await fetch(`/anime/${animeId}/details`);
                const data = await response.json();
                
                if (data.success) {
                    renderAnimeDetails(data.data);
                    renderEpisodes(data.data.episodes || []);
                    renderCharacters(data.data.characters || []);
                    renderRecommendations(data.data.recommendations || []);
                    renderDetails(data.data);
                } else {
                    showError('Anime not found');
                }
            } catch (error) {
                console.error('Error loading anime:', error);
                showError('Failed to load anime details');
            }
        }
        
        function renderAnimeDetails(anime) {
            // Update page title
            document.title = `${anime.title} - AniLab`;
            document.getElementById('animeTitle').textContent = anime.title;
            
            // Update hero section
            document.getElementById('animeMainTitle').textContent = anime.title;
            document.getElementById('animeAltTitle').textContent = anime.alternativeTitle || '';
            document.getElementById('animeType').textContent = anime.type || 'TV';
            document.getElementById('animeStatus').textContent = anime.status || 'Unknown';
            document.getElementById('animeEpisodes').textContent = anime.episodes?.eps || '?';
            document.getElementById('animeDuration').textContent = anime.duration || '24m';
            document.getElementById('animeRating').textContent = anime.rating || 'N/A';
            document.getElementById('animeSynopsis').textContent = anime.synopsis || 'No synopsis available.';
            
            // Update poster
            const poster = document.getElementById('animePoster');
            poster.src = anime.poster || '/assets/placeholder.jpg';
            poster.alt = anime.title;
            
            // Render genres
            const genresContainer = document.getElementById('animeGenres');
            if (anime.genres && anime.genres.length > 0) {
                genresContainer.innerHTML = anime.genres.map(genre => `
                    <a href="/genre/${genre.toLowerCase()}" class="tag is-purple">
                        ${genre}
                    </a>
                `).join('');
            }
            
            // Set watch button
            const watchBtn = document.getElementById('watchFirstEp');
            watchBtn.addEventListener('click', () => {
                window.location.href = `/watch/${anime.id}?ep=1`;
            });
            
            // Set background if available
            if (anime.background) {
                document.querySelector('.anime-detail-hero').style.setProperty(
                    '--anime-background', `url(${anime.background})`
                );
            }
        }
        
        function renderEpisodes(episodes) {
            const container = document.getElementById('episodeList');
            if (!container) return;
            
            if (episodes.length === 0) {
                container.innerHTML = `
                    <div class="col-span-full text-center py-12">
                        <i class="fas fa-film text-4xl text-gray-600 mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-400 mb-2">No Episodes Available</h3>
                        <p class="text-gray-500">Episodes will be added soon.</p>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = episodes.map(ep => `
                <div class="episode-card glass-card p-4 rounded-lg" data-lang="${ep.language || 'sub'}">
                    <div class="flex items-start">
                        <div class="flex-shrink-0 mr-4">
                            <div class="w-20 h-12 bg-gray-800 rounded flex items-center justify-center">
                                <span class="text-lg font-bold">EP ${ep.number}</span>
                            </div>
                        </div>
                        <div class="flex-grow">
                            <h4 class="font-medium mb-1 truncate">${ep.title || `Episode ${ep.number}`}</h4>
                            <div class="flex items-center text-sm text-gray-400">
                                <span class="mr-3">
                                    <i class="fas fa-clock"></i> ${ep.duration || '24m'}
                                </span>
                                <span class="tag is-small ${ep.language === 'dub' ? 'is-info' : 'is-success'}">
                                    ${ep.language === 'dub' ? 'DUB' : 'SUB'}
                                </span>
                                ${ep.isFiller ? '<span class="tag is-warning ml-2">Filler</span>' : ''}
                            </div>
                        </div>
                        <div>
                            <a href="/watch/${getAnimeIdFromUrl()}?ep=${ep.number}&lang=${ep.language || 'sub'}" 
                               class="button is-small is-purple">
                                <i class="fas fa-play"></i>
                            </a>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        function initTabs() {
            const tabLinks = document.querySelectorAll('.tab-link');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    
                    // Remove active class from all
                    tabLinks.forEach(l => l.classList.remove('is-active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked
                    link.classList.add('is-active');
                    const tabId = link.getAttribute('data-tab');
                    document.getElementById(tabId).classList.add('active');
                });
            });
        }
        
        function initEpisodeFilters() {
            const filters = document.querySelectorAll('.episode-filter');
            const episodes = document.querySelectorAll('.episode-card');
            
            filters.forEach(filter => {
                filter.addEventListener('click', () => {
                    // Update active filter
                    filters.forEach(f => f.classList.remove('active'));
                    filter.classList.add('active');
                    
                    const lang = filter.getAttribute('data-lang');
                    
                    // Show/hide episodes
                    episodes.forEach(ep => {
                        if (lang === 'all' || ep.getAttribute('data-lang') === lang) {
                            ep.style.display = 'block';
                            gsap.from(ep, { opacity: 0, y: 20, duration: 0.3 });
                        } else {
                            ep.style.display = 'none';
                        }
                    });
                });
            });
        }
    </script>
</body>
</html>